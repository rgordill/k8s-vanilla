---
# kubeadm cluster initialization

- name: Check if Kubernetes is already initialized
  ansible.builtin.stat:
    path: /etc/kubernetes/admin.conf
  register: kubeadm_init_check

- name: Pull Kubernetes images
  ansible.builtin.command: kubeadm config images pull
  when: not kubeadm_init_check.stat.exists
  changed_when: true

- name: Initialize Kubernetes cluster with kubeadm
  ansible.builtin.command: kubeadm init --config /root/kubeadm-config.yaml
  when: not kubeadm_init_check.stat.exists
  register: kubeadm_init_result
  changed_when: kubeadm_init_result.rc == 0

- name: Deploy kube-proxy addon
  ansible.builtin.command: kubeadm init phase addon kube-proxy --config /root/kubeadm-config.yaml
  register: kube_proxy_result
  changed_when: "'Applied essential addon: kube-proxy' in kube_proxy_result.stdout"

- name: Ensure kubeadm cluster-admins ClusterRoleBinding exists
  kubernetes.core.k8s:
    kubeconfig: /etc/kubernetes/super-admin.conf
    state: present
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: kubeadm:cluster-admins
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: cluster-admin
      subjects:
        - apiGroup: rbac.authorization.k8s.io
          kind: Group
          name: kubeadm:cluster-admins

- name: Create .kube directory for root
  ansible.builtin.file:
    path: /root/.kube
    state: directory
    mode: '0700'

- name: Copy admin.conf to root's .kube directory
  ansible.builtin.copy:
    src: /etc/kubernetes/admin.conf
    dest: /root/.kube/config
    remote_src: true
    mode: '0600'

- name: Create .kube directory for ansible_user
  ansible.builtin.file:
    path: "/home/{{ ansible_user }}/.kube"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0700'

- name: Copy admin.conf to ansible_user's .kube directory
  ansible.builtin.copy:
    src: /etc/kubernetes/admin.conf
    dest: "/home/{{ ansible_user }}/.kube/config"
    remote_src: true
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0600'

- name: Wait for API server to be ready
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
    kubeconfig: /root/.kube/config
  register: api_ready
  retries: "{{ (api_server_ready_timeout / 10) | int }}"
  delay: 10
  until: api_ready.resources is defined

- name: Label node with control-plane role
  kubernetes.core.k8s:
    kubeconfig: /root/.kube/config
    state: patched
    kind: Node
    name: "{{ ansible_hostname }}"
    definition:
      metadata:
        labels:
          node-role.kubernetes.io/control-plane: ""



