---
# Playbook to provision infrastructure with Terraform

- name: Provision infrastructure with Terraform
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    terraform_dir: "{{ playbook_dir }}/../../terraform"
    terraform_state_file: "{{ terraform_dir }}/terraform.tfstate"

  tasks:
    - name: Check if Terraform is initialized
      ansible.builtin.stat:
        path: "{{ terraform_dir }}/.terraform"
      register: terraform_init_check

    - name: Initialize Terraform
      ansible.builtin.command:
        cmd: terraform init
        chdir: "{{ terraform_dir }}"
      when: not terraform_init_check.stat.exists
      changed_when: true

    - name: Validate Terraform configuration
      ansible.builtin.command:
        cmd: terraform validate
        chdir: "{{ terraform_dir }}"
      changed_when: false

    - name: Apply Terraform configuration
      ansible.builtin.command:
        cmd: terraform apply -auto-approve
        chdir: "{{ terraform_dir }}"
      register: terraform_apply
      changed_when: "'Apply complete!' in terraform_apply.stdout"

    - name: Display Terraform outputs
      ansible.builtin.command:
        cmd: terraform output -json
        chdir: "{{ terraform_dir }}"
      register: terraform_outputs
      changed_when: false

    - name: Parse Terraform outputs
      ansible.builtin.set_fact:
        tf_outputs: "{{ terraform_outputs.stdout | from_json }}"

    - name: Display VM information
      ansible.builtin.debug:
        msg:
          - "VM Name: {{ tf_outputs.vm_name.value }}"
          - "VM IP: {{ tf_outputs.vm_ip.value }}"
          - "SSH User: {{ tf_outputs.ssh_user.value }}"

    - name: Wait for SSH to become available
      ansible.builtin.wait_for:
        host: "{{ tf_outputs.vm_ip.value }}"
        port: 22
        delay: 10
        timeout: 300
        state: started
      when: terraform_apply.changed



