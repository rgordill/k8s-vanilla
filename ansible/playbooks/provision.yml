---
# Playbook to provision infrastructure with Terraform
# Set terraform_provider variable to 'libvirt' or 'aws'

- name: Provision infrastructure with Terraform
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    terraform_dir: "{{ playbook_dir }}/../../terraform/{{ terraform_provider }}"
    terraform_state_file: "{{ terraform_dir }}/terraform.tfstate"

  pre_tasks:
    - name: Override terraform_provider from environment if set
      ansible.builtin.set_fact:
        terraform_provider: "{{ lookup('env', 'TERRAFORM_PROVIDER') }}"
      when: lookup('env', 'TERRAFORM_PROVIDER') | length > 0

  tasks:
    - name: Display selected provider
      ansible.builtin.debug:
        msg: "Provisioning with Terraform provider: {{ terraform_provider }}"

    - name: Validate provider selection
      ansible.builtin.assert:
        that:
          - terraform_provider in ['libvirt', 'aws']
        fail_msg: "Invalid terraform_provider '{{ terraform_provider }}'. Must be 'libvirt' or 'aws'."
        success_msg: "Using provider: {{ terraform_provider }}"

    - name: Check if Terraform directory exists
      ansible.builtin.stat:
        path: "{{ terraform_dir }}"
      register: terraform_dir_check

    - name: Fail if Terraform directory does not exist
      ansible.builtin.fail:
        msg: "Terraform directory '{{ terraform_dir }}' does not exist"
      when: not terraform_dir_check.stat.exists

    - name: Check if Terraform is initialized
      ansible.builtin.stat:
        path: "{{ terraform_dir }}/.terraform"
      register: terraform_init_check

    - name: Initialize Terraform
      ansible.builtin.command:
        cmd: terraform init
        chdir: "{{ terraform_dir }}"
      when: not terraform_init_check.stat.exists
      changed_when: true

    - name: Validate Terraform configuration
      ansible.builtin.command:
        cmd: terraform validate
        chdir: "{{ terraform_dir }}"
      changed_when: false

    - name: Apply Terraform configuration
      ansible.builtin.command:
        cmd: terraform apply -auto-approve
        chdir: "{{ terraform_dir }}"
      register: terraform_apply
      changed_when: "'Apply complete!' in terraform_apply.stdout"

    - name: Display Terraform outputs
      ansible.builtin.command:
        cmd: terraform output -json
        chdir: "{{ terraform_dir }}"
      register: terraform_outputs
      changed_when: false

    - name: Parse Terraform outputs
      ansible.builtin.set_fact:
        tf_outputs: "{{ terraform_outputs.stdout | from_json }}"

    - name: Display VM information
      ansible.builtin.debug:
        msg:
          - "Provider: {{ terraform_provider }}"
          - "VM Name: {{ tf_outputs.vm_name.value }}"
          - "VM IP: {{ tf_outputs.vm_ip.value }}"
          - "SSH User: {{ tf_outputs.ssh_user.value }}"

    - name: Set TERRAFORM_PROVIDER environment hint
      ansible.builtin.debug:
        msg: "Run 'export TERRAFORM_PROVIDER={{ terraform_provider }}' before running other playbooks"

    - name: Wait for SSH to become available
      ansible.builtin.wait_for:
        host: "{{ tf_outputs.vm_ip.value }}"
        port: 22
        delay: 10
        timeout: 300
        state: started
      when: terraform_apply.changed
